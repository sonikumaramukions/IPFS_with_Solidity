<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockVault - Secure Document Storage</title>
    <!-- More reliable ethers.js loading strategy -->
    <script type="text/javascript">
        // Function to load ethers.js from various CDNs with fallbacks
        function loadEthers() {
            const cdnSources = [
                "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js",
                "https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js",
                "https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"
            ];

            function tryLoadScript(index) {
                if (index >= cdnSources.length) {
                    console.error("Failed to load ethers.js from all sources");
                    document.getElementById('walletAddress').innerText = "‚ùå Failed to load Ethereum library";
                    return;
                }

                const script = document.createElement('script');
                script.src = cdnSources[index];
                script.type = 'text/javascript';
                script.onload = function() {
                    console.log("Ethers.js loaded successfully from: " + cdnSources[index]);
                };
                script.onerror = function() {
                    console.warn("Failed to load ethers.js from: " + cdnSources[index]);
                    tryLoadScript(index + 1);
                };
                document.head.appendChild(script);
            }

            tryLoadScript(0);
        }

        // Load ethers.js as soon as possible
        loadEthers();
    </script>
    <!-- Animation library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --accent: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            
            --gradient-primary: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            --gradient-secondary: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-accent: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --gradient-dark: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Navigation */
        .navbar {
            background: white;
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-links a {
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: var(--primary);
            color: white;
        }

        /* Wallet Section */
        .wallet-section {
            position: fixed;
            top: 1rem;
            right: 2rem;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        #connectButton {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow);
        }

        #connectButton:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        #connectButton.connected {
            background: var(--gradient-secondary);
        }

        #walletAddress {
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: var(--dark);
            font-size: 0.875rem;
            box-shadow: var(--shadow);
        }

        /* Main Content */
        .main-content {
            padding-top: 80px;
            min-height: calc(100vh - 80px);
        }

        /* Hero Section */
        .hero {
            background: var(--gradient-primary);
            color: white;
            padding: 6rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .hero p {
            font-size: 1.25rem;
            max-width: 600px;
            margin: 0 auto 2rem;
            opacity: 0.9;
        }

        /* Sections */
        .section {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
        }

        .section h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 2rem;
            font-weight: 600;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-secondary {
            background: var(--gradient-secondary);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* File Input */
        .file-input-wrapper {
            border: 2px dashed #e2e8f0;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-input-wrapper:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .file-input-label {
            display: block;
            cursor: pointer;
        }

        .file-input-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .file-input-icon {
            font-size: 2rem;
            color: var(--primary);
        }

        /* Results */
        .result, .output {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 0.5rem;
            background: #f8fafc;
        }

        .success-message {
            color: var(--secondary-dark);
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .error-message {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Loading Spinner */
        .loading {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .section {
                padding: 1.5rem;
                margin: 1rem;
            }
        }

        /* History Section */
        .history-section {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            display: grid;
            grid-template-columns: 2fr 3fr 1fr;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            align-items: center;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-filename {
            font-weight: 500;
            color: var(--dark);
        }

        .history-cid {
            font-family: monospace;
            color: var(--primary);
            word-break: break-all;
        }

        .history-timestamp {
            color: var(--gray);
            font-size: 0.875rem;
            text-align: right;
        }

        .empty-history {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
        }

        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: var(--primary-dark);
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="#" class="logo">üß± BlockVault</a>
            <div class="nav-links">
                <a href="#upload">Upload</a>
                <a href="#retrieve">Retrieve</a>
                <a href="#history">History</a>
                <a href="#about">About Us</a>
                <a href="#contact">Contact</a>
            </div>
        </div>
    </nav>

    <!-- Wallet Section -->
    <div class="wallet-section">
        <button id="connectButton" class="btn">
            <span id="connectButtonText">üîó Connect Wallet</span>
            <span class="loading" style="display: none;"></span>
        </button>
        <div id="walletAddress"></div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Hero Section -->
        <section class="hero">
            <h1>Secure Document Storage on Blockchain</h1>
            <p>Store your important documents securely using IPFS and Ethereum blockchain</p>
            <button class="btn btn-primary" onclick="showSection('upload')">Get Started</button>
        </section>

        <!-- Upload Section -->
        <section id="uploadSection" class="section">
            <h2>Upload Document</h2>
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" id="title" name="title" placeholder="Document Title" required />
            </div>
            
            <div class="form-group">
                <label for="description">Description</label>
                <input type="text" id="description" name="description" placeholder="Short description of the document" required />
            </div>
            
            <div class="form-group">
                <label>Document File</label>
                <div class="file-input-wrapper">
                    <label class="file-input-label">
                        <div class="file-input-text">
                            <div class="file-input-icon">üìÑ</div>
                            <div id="file-name">Choose a file or drag it here</div>
                        </div>
                        <input type="file" name="document" id="document" required style="display: none;" />
                    </label>
                </div>
            </div>
            
            <button type="button" id="uploadButton" class="btn btn-primary">
                Upload to Blockchain
            </button>
            <div id="result"></div>
        </section>

        <!-- Retrieve Section -->
        <section id="retrieveSection" class="section">
            <h2>Retrieve Document</h2>
            <div class="form-group">
                <label for="ipfsHash">IPFS Hash</label>
                <input type="text" id="ipfsHash" name="ipfsHash" placeholder="Enter IPFS Hash to retrieve document" required />
            </div>
            <button type="button" id="retrieveButton" class="btn btn-primary">Fetch Document</button>
            <div id="output"></div>
        </section>

        <!-- History Section -->
        <section id="historySection"  class="section">
            <h2>Upload History</h2>
            <button onclick="fetchCIDHistory()">View CID History</button>
            <div id="cid-history-display">
                <div id="cidHistory" style="margin-top: 30px;"></div>

            </div>
        </section>

        <!-- About Section -->
        <section id="about" class="section">
            <h2>About BlockVault</h2>
            <p>Welcome to BlockVault!</p>
            <p>We are a passionate team of developers working to make document storage safer, smarter, and decentralized.</p>
            <p>Our project combines the power of IPFS (InterPlanetary File System) and Blockchain (Ethereum) to ensure your important documents are securely stored, easily accessible, and tamper-proof.</p>
            <p>With BlockVault, users can:</p>
            <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                <li>Upload files securely to IPFS via Pinata</li>
                <li>Connect their Ethereum wallet (MetaMask) for transaction verification</li>
                <li>Instantly get a unique IPFS hash for every upload</li>
                <li>Maintain a history of all uploaded CIDs with timestamps</li>
                <li>Retrieve documents anytime using the IPFS hash</li>
            </ul>
        </section>

        <!-- Contact Section -->
        <section id="contact" class="section">
            <h2>Contact Us</h2>
            <div class="contact-info">
                <p>üìû Phone: 123456789</p>
                <p>‚úâÔ∏è Email: abcdefgh@gmail.com</p>
            </div>
        </section>
    </div>

    <script>
        let provider = null;
        let signer = null;
        let contract = null;
        const CONTRACT_ADDRESS = "0x5fbdb2d56cdae59174d9d44ca8992a9242998b8a"; // Replace with your contract address AFTER deployment
        const CONTRACT_ABI = [
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "ipfsHash",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "fileName",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "timestamp",
                        "type": "uint256"
                    }
                ],
                "name": "DocumentStored",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    }
                ],
                "name": "getDocuments",
                "outputs": [
                    {
                        "components": [
                            {
                                "internalType": "string",
                                "name": "ipfsHash",
                                "type": "string"
                            },
                            {
                                "internalType": "string",
                                "name": "fileName",
                                "type": "string"
                            },
                            {
                                "internalType": "uint256",
                                "name": "timestamp",
                                "type": "uint256"
                            }
                        ],
                        "internalType": "struct BlockVault.Document[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "ipfsHash",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "fileName",
                        "type": "string"
                    }
                ],
                "name": "storeDocument",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            }
        ]; // Use your ABI

        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded, attaching event handlers using standard method...");

            const uploadButton = document.getElementById('uploadButton');
            const retrieveButton = document.getElementById('retrieveButton');
            
            if (uploadButton) {
                console.log("Attaching click listener to #uploadButton");
                uploadButton.addEventListener('click', function(event) {
                    // ///// IMMEDIATE DEBUGGING START /////
                    console.error("!!!!!!!! UPLOAD BUTTON CLICK LISTENER FIRED !!!!!!!!!!");
                    alert("Upload Listener Fired! Press OK. Does it reload AFTER this?"); 
                    // ///// IMMEDIATE DEBUGGING END /////
                    
                    console.log("#uploadButton clicked, preventing default...");
                    // Prevent any default action associated with the button or potential form
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // Call the upload handler
                    handleUpload();
                    
                    // Explicitly return false as an extra measure
                    return false;
                });
            } else {
                console.error("Upload button (#uploadButton) not found in DOM");
            }
            
            if (retrieveButton) {
                console.log("Attaching click listener to #retrieveButton");
                retrieveButton.addEventListener('click', function(event) {
                    console.log("#retrieveButton clicked");
                    event.preventDefault();
                    event.stopPropagation();
                    handleRetrieve();
                    return false;
                });
            } else {
                console.error("Retrieve button (#retrieveButton) not found in DOM");
            }
            
            // Initialize other elements and handlers
            const connectButton = document.getElementById('connectButton');
            const fileInput = document.getElementById('document');
            const fileNameDisplay = document.getElementById('file-name');
            
            if(connectButton) {
                 connectButton.onclick = connectWallet; 
            }
            
            // File input handling
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        fileNameDisplay.textContent = e.target.files[0].name;
                        e.target.closest('.file-input-label').classList.add('file-selected');
                    } else {
                        fileNameDisplay.textContent = 'Choose a file or drag it here';
                        e.target.closest('.file-input-label').classList.remove('file-selected');
                    }
                });
            }
            
            // Drag and drop handling
            const dropArea = document.querySelector('.file-input-label');
            if (dropArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight() {
                    dropArea.classList.add('highlight');
                }
                
                function unhighlight() {
                    dropArea.classList.remove('highlight');
                }
                
                dropArea.addEventListener('drop', handleDrop, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    fileInput.files = files;
                    
                    if (files.length > 0) {
                        fileNameDisplay.textContent = files[0].name;
                        dropArea.classList.add('file-selected');
                    }
                }
            }
            
            // Check if MetaMask is installed
            if (typeof window.ethereum === 'undefined') {
                const walletAddressDiv = document.getElementById('walletAddress');
                const connectButtonText = document.getElementById('connectButtonText');
                
                if (walletAddressDiv) walletAddressDiv.innerText = "‚ùå MetaMask not found";
                if (connectButtonText) connectButtonText.innerText = "Install MetaMask";
            } else {
                // Set up MetaMask event listeners
                window.ethereum.on('accountsChanged', function(accounts) {
                    if (accounts.length === 0) {
                        // Handle account disconnection
                        const walletAddressDiv = document.getElementById('walletAddress');
                        const connectButton = document.getElementById('connectButton');
                        const connectButtonText = document.getElementById('connectButtonText');

                        if (walletAddressDiv) walletAddressDiv.innerText = "‚ùå Disconnected";
                        if (connectButton && connectButtonText) {
                            connectButton.style.background = 'var(--secondary-gradient)';
                            connectButtonText.innerText = 'üîó Connect Wallet';
                        }

                        provider = null;
                        signer = null;
                        contract = null;
                    } else {
                        // Reconnect when account changes
                        connectWallet();
                    }
                });

                window.ethereum.on('chainChanged', function() {
                    // Reload the page when chain changes
                    window.location.reload();
                });
            }

            // Initialize history display
            displayCIDHistory();

            // History button
            const historyButton = document.getElementById('historyBtn');
            if (historyButton) {
                historyButton.addEventListener('click', () => showSection('history'));
            }

            // Add hover effects to interactive elements
            document.querySelectorAll('.interactive-card').forEach(card => {
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-5px)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                });
            });
        });

        function showSection(section) {
             // Remove active class from all buttons
            const uploadBtn = document.getElementById('uploadBtn');
            const retrieveBtn = document.getElementById('retrieveBtn');
            const historyBtn = document.getElementById('historyBtn');
            if(uploadBtn) uploadBtn.classList.remove('active');
            if(retrieveBtn) retrieveBtn.classList.remove('active');
            if(historyBtn) historyBtn.classList.remove('active');
            
            // Add active class to clicked button
            const activeBtn = document.getElementById(section + 'Btn');
            if(activeBtn) activeBtn.classList.add('active');
            
            // Get all sections and hide them with animation
            const sections = document.querySelectorAll('.section');
            sections.forEach(s => {
                s.classList.remove('active');
            });
            
            // Show the selected section with animation
            const targetSection = document.getElementById(section + 'Section');
            if(targetSection) {
                void targetSection.offsetWidth; // Trigger reflow for animation reset
                targetSection.classList.add('active');
            }
        }

        async function connectWallet() {
            const connectButton = document.getElementById('connectButton');
            const connectButtonText = document.getElementById('connectButtonText');
            const loadingSpinner = connectButton.querySelector('.loading');
            const walletAddressDiv = document.getElementById('walletAddress');

            // UI update helper
            function updateConnectUI(text, isLoading, isConnected = false) {
                if(connectButtonText) {
                    connectButtonText.innerText = text;
                    connectButtonText.style.opacity = isLoading ? '0.5' : '1';
                }
                if(loadingSpinner) {
                    loadingSpinner.style.display = isLoading ? 'inline-block' : 'none';
                }
                if(connectButton) {
                    connectButton.classList.toggle('connected', isConnected);
                }
            }

            try {
                // Check if MetaMask is installed
                if (typeof window.ethereum === 'undefined') {
                    alert("Please install MetaMask!");
                    updateConnectUI("Install MetaMask", false);
                    if(walletAddressDiv) walletAddressDiv.innerText = "‚ùå MetaMask not found";
                    return;
                }

                updateConnectUI("Connecting...", true);
                if(walletAddressDiv) walletAddressDiv.innerText = "üîÑ Connecting...";

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                if (!accounts || accounts.length === 0) {
                    alert("No accounts found. Please connect an account in MetaMask.");
                    updateConnectUI("Connect Wallet", false);
                    if(walletAddressDiv) walletAddressDiv.innerText = "‚ùå No accounts connected";
                    return;
                }

                // Initialize ethers provider
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // Get signer
                signer = provider.getSigner();
                
                // Get address
                const address = await signer.getAddress();
                
                // Initialize contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // Update UI
                const formattedAddress = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
                if(walletAddressDiv) walletAddressDiv.innerText = "üü¢ Connected: " + formattedAddress;
                updateConnectUI("‚úÖ Connected", false, true);

                // Add pulse animation to connected elements
                document.querySelectorAll('.interactive-card').forEach(card => {
                    card.classList.add('pulse');
                });

            } catch (err) {
                console.error("Wallet connection failed:", err);
                updateConnectUI("Connection Failed", false);
                if(walletAddressDiv) walletAddressDiv.innerText = "‚ùå Connection failed: " + (err.message || "Unknown error");
                alert("Failed to connect wallet: " + (err.message || "Unknown error"));
            }
        }

        async function fetchCIDHistory() {
  try {
    const response = await fetch('http://localhost:5000/cid-history');
    const result = await response.json();
    
    if (result.success) {
      const cidHistoryDiv = document.getElementById('cidHistory');
      cidHistoryDiv.innerHTML = ''; // Clear previous content

      // Create Table
      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';

      // Table Header
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = `
        <th style="border: 1px solid #ddd; padding: 8px;">CID</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Timestamp</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
      `;
      table.appendChild(headerRow);

      // Table Data
      result.history.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="border: 1px solid #ddd; padding: 8px;">${item.cid}</td>
          <td style="border: 1px solid #ddd; padding: 8px;">${new Date(item.timestamp).toLocaleString()}</td>
          <td style="border: 1px solid #ddd; padding: 8px;">
            <button onclick="copyText('${item.cid}')" style="padding: 5px 10px; background: #3182ce; color: white; border: none; border-radius: 5px; cursor: pointer;">üìã Copy CID</button>
          </td>
        `;
        table.appendChild(row);
      });

      cidHistoryDiv.appendChild(table);
    } else {
      alert('Failed to fetch CID history.');
    }
  } catch (error) {
    console.error('Error fetching CID history:', error);
    alert('An error occurred while fetching CID history.');
  }
}

// Copy Function
function copyText(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('‚úÖ CID copied to clipboard!');
  }).catch(err => {
    console.error('Failed to copy text: ', err);
  });
}


        // UPLOAD HANDLER WITH FULL TRY/CATCH
        async function handleUpload() {
             console.log("handleUpload function started"); // Restoring full functionality
             const resultDiv = document.getElementById('result');

             // Define UI update helper function
             function updateResultUI(message, type = 'info') {
                 let className = 'info';
                 if (type === 'success') className = 'success-message';
                 if (type === 'error') className = 'error-message';
                 if (type === 'warning') className = 'warning-message'; // Define warning class if needed
                 
                 resultDiv.innerHTML = `
                     <div class="${className} animate__animated animate__fadeIn">
                         ${message}
                     </div>`;
             }

             // Wrap the entire function in a try...catch block
             try {
                 // Check for wallet connection first
                 if (!provider || !signer) {
                     console.log("Wallet not connected");
                     updateResultUI(`
                         <p>Please connect your wallet first.</p>
                         <button onclick="connectWallet()" class="btn btn-primary">Connect Wallet</button>
                     `, 'error');
                     return;
                 }
                 
                 // Get form values
                 const titleInput = document.getElementById('title');
                 const descriptionInput = document.getElementById('description');
                 const fileInput = document.getElementById('document');
                 
                 if (!titleInput || !descriptionInput || !fileInput) {
                     console.error("Form elements not found");
                     updateResultUI(`<p>‚ùå Form elements not found</p>`, 'error');
                     return;
                 }
                 
                 const file = fileInput.files[0];
                 const title = titleInput.value;
                 const description = descriptionInput.value;

                 // Validation
                 if (!file) {
                     updateResultUI(`<p>‚ùå Please select a file to upload</p>`, 'error');
                     return;
                 }
                 if (!title.trim()) {
                     updateResultUI(`<p>‚ùå Please enter a title</p>`, 'error');
                     return;
                 }
                 if (!description.trim()) {
                     updateResultUI(`<p>‚ùå Please enter a description</p>`, 'error');
                     return;
                 }

                 // Show loading message for IPFS
                 updateResultUI(`<p><span class="loading" style="display: inline-block; vertical-align: middle; margin-right: 10px;"></span> Uploading to IPFS...</p>`, 'info');
                 
                 // Step 1: Upload to IPFS via server
                 console.log("Uploading to IPFS...");
                 const formData = new FormData();
                 formData.append('document', file);
                 formData.append('title', title);
                 formData.append('description', description);
                 
                 const res = await fetch('http://localhost:5000/upload', {
                     method: 'POST',
                     body: formData,
                 });
                 const data = await res.json();

                 if (!data.success) {
                      console.error("IPFS upload failed:", data.error);
                      updateResultUI(`<p>‚ùå IPFS upload failed: ${data.error || 'Unknown error'}</p>`, 'error');
                      return;
                 }
                 console.log("IPFS upload successful, hash:", data.hash);
                 
                  // Double check contract instance exists
                 if (!contract) {
                     console.log("Contract not found, trying to recreate...");
                     try {
                         contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                         if (!contract) throw new Error("Contract recreation failed");
                     } catch (err) {
                         console.error("Failed to create contract instance:", err);
                          updateResultUI(`
                             <p>‚ùå Blockchain connection error. File uploaded to IPFS but cannot proceed.</p>
                             <p>IPFS Hash: <span style="font-family: monospace; background: #f3f4f6; padding: 4px 8px; border-radius: 4px;">${data.hash}</span></p>
                         `, 'error');
                          return;
                     }
                 }
                 
                 // Show message while waiting for MetaMask approval
                 updateResultUI(`
                     <p><span class="loading" style="display: inline-block; vertical-align: middle; margin-right: 10px;"></span> Waiting for MetaMask approval...</p>
                     <p>Please check your MetaMask wallet and approve the transaction.</p>
                     <p>IPFS Hash: ${data.hash}</p>
                 `, 'info');

                 // Step 2: Blockchain transaction
                 const txAmount = "0.01";
                 const txOptions = { value: ethers.utils.parseEther(txAmount), gasLimit: 300000 };
                 console.log("Sending transaction to contract...", { hash: data.hash, fileName: file.name, options: txOptions });
                 
                 const tx = await contract.storeDocument(data.hash, file.name, txOptions);
                 console.log("Transaction sent:", tx.hash);

                 // Show message while waiting for confirmation
                 updateResultUI(`
                     <p><span class="loading" style="display: inline-block; vertical-align: middle; margin-right: 10px;"></span> Transaction submitted, waiting for confirmation...</p>
                     <p>Transaction hash: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank">${tx.hash.substring(0, 10)}...${tx.hash.substring(tx.hash.length - 8)}</a></p>
                 `, 'info');

                 const receipt = await tx.wait();
                 console.log("Transaction mined:", receipt);

                 // Calculate costs
                 const gasUsed = receipt.gasUsed;
                 const gasPrice = receipt.effectiveGasPrice || tx.gasPrice;
                 const gasCostWei = gasUsed.mul(gasPrice);
                 const gasCostEth = ethers.utils.formatEther(gasCostWei);
                 const totalCost = (parseFloat(gasCostEth) + parseFloat(txAmount)).toFixed(5);
                 console.log("Transaction complete - details:", { gasUsed: gasUsed.toString(), gasCostEth, totalCost });

                 // Show success message
                 updateResultUI(`
                     <h3 style="color: #065f46; margin-top: 0;">‚úÖ Upload Successful!</h3>
                     <p><strong>Transaction Details:</strong></p>
                     <p>üìÑ File: ${file.name}</p>
                     <p>üí∞ Transaction Cost: ${totalCost} ETH (${txAmount} ETH fee + ${gasCostEth} ETH gas)</p>
                     <p>üîó Transaction Hash: <a href="https://etherscan.io/tx/${receipt.transactionHash}" target="_blank">${receipt.transactionHash.substring(0, 10)}...${receipt.transactionHash.substring(receipt.transactionHash.length - 8)}</a></p>
                     <p><strong>IPFS Details:</strong></p>
                     <p>üì¶ IPFS Hash: <span style="font-family: monospace; background: #f3f4f6; padding: 4px 8px; border-radius: 4px;">${data.hash}</span></p>
                     <p>üîç Use this hash in the Retrieve Document section to access your file</p>
                     <div style="display: flex; gap: 10px; margin-top: 15px;">
                         <a href="https://ipfs.io/ipfs/${data.hash}" target="_blank" class="btn btn-primary" style="flex: 1;">View on IPFS Gateway</a>
                         <button onclick="copyToClipboard('${data.hash}')" class="btn" style="flex: 1; background: #6b7280; color: white;">Copy Hash</button>
                     </div>
                 `, 'success');

                 // Reset form manually
                 titleInput.value = '';
                 descriptionInput.value = '';
                 fileInput.value = ''; // This clears the file input
                 const fileNameDisplay = document.getElementById('file-name');
                 if(fileNameDisplay) fileNameDisplay.textContent = 'Choose a file or drag it here';
                 const fileLabel = fileInput.closest('.file-input-label');
                 if(fileLabel) fileLabel.classList.remove('file-selected');

                 // After successful upload, update history
                 updateCIDHistory(data.hash, file.name);

             } catch (error) {
                 console.error("Error during upload process:", error);
                 let errorMessage = `<p>‚ùå An unexpected error occurred: ${error.message || 'Unknown error'}</p>`;
                 
                 // Handle specific transaction errors
                 if (error.code === 4001 || (error.message && error.message.includes("user rejected"))) {
                     errorMessage = `
                         <p>‚ùå Transaction rejected by user.</p>
                         <p>File upload might have succeeded on IPFS, but it was not registered on the blockchain.</p>
                     `;
                     // Optionally show IPFS hash if available from `data` variable scope (needs adjustment)
                 } else if (error.message && error.message.includes("insufficient funds")) {
                     errorMessage = `<p>‚ùå Transaction failed: Insufficient funds for gas.</p>`;
                 }
                 
                 updateResultUI(errorMessage, 'error');
             }
             // No return false needed here as the event listener handles prevention
         }
         
         // Handler for retrieve button click
         async function handleRetrieve() {
             console.log("Retrieve button clicked");
             const outputDiv = document.getElementById('output');
             const ipfsHashInput = document.getElementById('ipfsHash');
             
             if (!ipfsHashInput) {
                 console.error("IPFS hash input not found");
                 outputDiv.innerHTML = `<div class="error-message"><p>‚ùå Input element not found</p></div>`;
                 return;
             }
             
             const ipfsHash = ipfsHashInput.value;
             console.log("Attempting to retrieve IPFS hash:", ipfsHash);

             if (!ipfsHash.trim()) {
                 outputDiv.innerHTML = `<div class="error-message"><p>‚ùå Please enter an IPFS Hash.</p></div>`;
                 return;
             }

             try {
                 // Show loading state
                 outputDiv.innerHTML = `
                 <div class="info animate__animated animate__fadeIn">
                     <p><span class="loading" style="display: inline-block; vertical-align: middle; margin-right: 10px;"></span> Fetching document from IPFS...</p>
                 </div>`;
                 
                 // Show results immediately (assuming IPFS link is valid)
                 // In a real app, you might want to verify the hash exists first
                 setTimeout(() => {
                     const ipfsLink = `https://ipfs.io/ipfs/${ipfsHash}`;
                     outputDiv.innerHTML = `
                     <div class="success-message animate__animated animate__fadeIn">
                         <h3 style="color: #065f46; margin-top: 0;">üìÑ Document Info</h3>
                         <p><strong>IPFS Hash:</strong> <span style="font-family: monospace; background: #f3f4f6; padding: 4px 8px; border-radius: 4px;">${ipfsHash}</span></p>
                         <div style="display: flex; gap: 10px; margin-top: 15px;">
                             <a href="${ipfsLink}" target="_blank" class="btn btn-primary" style="flex: 1;">View Document</a>
                             <a href="${ipfsLink}" download class="btn btn-success" style="flex: 1;">Download</a>
                             <button onclick="copyToClipboard('${ipfsHash}')" class="btn" style="flex: 1; background: #6b7280; color: white;">Copy Hash</button>
                         </div>
                     </div>`;
                 }, 500); // Short delay for perceived loading

             } catch (err) {
                 console.error("Retrieve error:", err);
                 outputDiv.innerHTML = `<div class="error-message"><p>‚ùå Error retrieving document: ${err.message}</p></div>`;
             }
         }

         // Utility function to copy text to clipboard
         function copyToClipboard(text) {
             navigator.clipboard.writeText(text).then(() => {
                 // Show a temporary tooltip
                 const tooltip = document.createElement('div');
                 tooltip.textContent = 'Copied!';
                 tooltip.style.position = 'fixed';
                 tooltip.style.top = '50%';
                 tooltip.style.left = '50%';
                 tooltip.style.transform = 'translate(-50%, -50%)';
                 tooltip.style.padding = '10px 20px';
                 tooltip.style.background = 'rgba(0, 0, 0, 0.8)';
                 tooltip.style.color = 'white';
                 tooltip.style.borderRadius = '5px';
                 tooltip.style.zIndex = '9999';
                 tooltip.style.animation = 'fadeInOut 1.5s ease forwards';
                 
                 // Add keyframe animation for the tooltip
                 const style = document.createElement('style');
                 style.textContent = `
                 @keyframes fadeInOut {
                     0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                     20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                     80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                     100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                 }`;
                 document.head.appendChild(style);
                 
                 document.body.appendChild(tooltip);
                 
                 // Remove tooltip after animation
                 setTimeout(() => {
                     if (document.body.contains(tooltip)) { 
                         document.body.removeChild(tooltip);
                     }
                 }, 1500);
             }).catch(err => {
                 console.error('Failed to copy text: ', err);
             });
         }

        // Constants
        const MINIMUM_PAYMENT = ethers.utils.parseEther("0.0001"); // 0.0001 ETH
        let cidHistory = JSON.parse(localStorage.getItem('cidHistory') || '[]');

        // Function to update CID history
        function updateCIDHistory(cid, filename) {
            const historyItem = {
                cid,
                filename,
                timestamp: new Date().toLocaleString()
            };
            cidHistory.unshift(historyItem);
            localStorage.setItem('cidHistory', JSON.stringify(cidHistory));
            displayCIDHistory();
        }

        // Function to display CID history
        function displayCIDHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;

            if (cidHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <p>No uploads yet</p>
                        <p>Upload your first document to see it here</p>
                    </div>
                `;
                return;
            }

            historyList.innerHTML = cidHistory.map(item => `
                <div class="history-item">
                    <div class="history-filename">${item.filename}</div>
                    <div class="history-cid">${item.cid}</div>
                    <div class="history-timestamp">
                        ${item.timestamp}
                        <button class="copy-btn" onclick="copyToClipboard('${item.cid}')">Copy</button>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>

</html>