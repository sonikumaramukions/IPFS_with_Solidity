<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockVault - Secure Document Storage</title>
    <!-- More reliable ethers.js loading strategy -->
    <script type="text/javascript">
        // Function to load ethers.js from various CDNs with fallbacks
        function loadEthers() {
            const cdnSources = [
                "https://cdn.jsdelivr.net/npm/ethers@6.13.5/dist/ethers.umd.min.js",
                "https://unpkg.com/ethers@6.13.5/dist/ethers.umd.min.js",
                "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.5/ethers.umd.min.js"
            ];

            function tryLoadScript(index) {
                if (index >= cdnSources.length) {
                    console.error("Failed to load ethers.js from all sources");
                    const walletAddressDiv = document.getElementById('walletAddress');
                    if (walletAddressDiv) walletAddressDiv.innerText = "‚ùå Failed to load Ethereum library";
                    // Disable buttons requiring ethers
                    const connectButton = document.getElementById('connectButton');
                    const uploadButton = document.getElementById('uploadButton');
                    const retrieveButton = document.getElementById('retrieveButton');
                    if(connectButton) connectButton.disabled = true;
                    if(uploadButton) uploadButton.disabled = true;
                    if(retrieveButton) retrieveButton.disabled = true;

                    return;
                }

                const script = document.createElement('script');
                script.src = cdnSources[index];
                script.type = 'text/javascript';
                script.onload = function() {
                    console.log("Ethers.js loaded successfully from: " + cdnSources[index]);
                    // You might want to initialize wallet connection attempt here if needed
                    // checkAndConnectWallet(); // Example function call
                };
                script.onerror = function() {
                    console.warn("Failed to load ethers.js from: " + cdnSources[index]);
                    tryLoadScript(index + 1);
                };
                document.head.appendChild(script);
            }

            // Check if ethers is already loaded (e.g., by another script)
            if (typeof window.ethers === 'undefined') {
                 tryLoadScript(0);
            } else {
                console.log("Ethers.js already loaded.");
                 // Proceed with initialization if needed
                 // checkAndConnectWallet(); // Example function call
            }
        }

        // Load ethers.js as soon as possible
        loadEthers();
    </script>
    <!-- Animation library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --accent: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;

            --gradient-primary: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            --gradient-secondary: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-accent: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --gradient-dark: linear-gradient(135deg, #1e293b 0%, #334155 100%);

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Navigation */
        .navbar {
            background: white;
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-links a {
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: var(--primary);
            color: white;
        }

        /* Wallet Section */
        .wallet-section {
            /* Removed fixed positioning, integrate into navbar */
            /* position: fixed; */
            /* top: 1rem; */
            /* right: 2rem; */
            /* z-index: 1001; */
            display: flex;
            /* flex-direction: column; */
            align-items: center; /* Align items horizontally */
            gap: 1rem; /* Adjust gap */
        }

        #connectButton {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex; /* Changed from flex */
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow);
            white-space: nowrap; /* Prevent wrapping */
        }

        #connectButton:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        #connectButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #connectButton.connected {
            background: var(--gradient-secondary);
        }

        #walletAddress {
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: var(--dark);
            font-size: 0.875rem;
            box-shadow: var(--shadow);
            white-space: nowrap; /* Prevent wrapping */
            max-width: 200px; /* Limit width */
            overflow: hidden;
            text-overflow: ellipsis; /* Add ellipsis for overflow */
        }

        /* Main Content */
        .main-content {
            padding-top: 100px; /* Increased padding for fixed navbar */
            min-height: calc(100vh - 80px); /* Adjust if footer height changes */
        }

        /* Hero Section */
        .hero {
            background: var(--gradient-primary);
            color: white;
            padding: 6rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .hero p {
            font-size: 1.25rem;
            max-width: 600px;
            margin: 0 auto 2rem;
            opacity: 0.9;
        }

        /* Sections */
        .section {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            /* Initially hide sections other than the first one (or handle via JS) */
             /* display: none; */ /* Add this if handling visibility purely with JS */
        }
        /* Add active state for sections if needed */
        .section.active {
            display: block;
             animation: fadeIn 0.5s ease-in-out;
        }
         @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }


        .section h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 2rem;
            font-weight: 600;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group input[type="file"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: white; /* Ensure background */
        }

        .form-group input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .form-group input[type="file"] {
             padding: 0; /* Reset padding for file input if needed */
             border: none; /* Reset border for file input if needed */
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-secondary {
            background: var(--gradient-secondary);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }


        /* File Input */
        .file-input-wrapper {
            border: 2px dashed #e2e8f0;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background-color: #f8fafc; /* Lighter background */
        }

        .file-input-wrapper.highlight { /* Style for dragover */
             border-color: var(--primary);
             background: rgba(37, 99, 235, 0.1);
        }

        .file-input-wrapper:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .file-input-label {
            display: block;
            cursor: pointer;
        }

        .file-input-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray);
        }
        .file-input-label.file-selected .file-input-text {
            color: var(--dark); /* Change text color when file selected */
            font-weight: 500;
        }


        .file-input-icon {
            font-size: 2rem;
            color: var(--primary);
        }

        /* Results */
        .result, .output {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 0.5rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            word-break: break-word; /* Prevent long strings from overflowing */
        }

         .result div, .output div { /* Target inner divs for animation */
              animation: fadeIn 0.3s ease-in-out;
         }

        .success-message {
            color: var(--secondary-dark);
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .error-message {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
         .info-message { /* Added for loading/info states */
             color: var(--primary-dark);
             background: rgba(37, 99, 235, 0.1);
             border: 1px solid rgba(37, 99, 235, 0.2);
         }


        /* Loading Spinner */
        .loading {
            display: inline-block; /* Make sure it takes space */
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.1); /* Use background-relative color */
            border-radius: 50%;
            border-top-color: var(--primary); /* Spinner color */
            animation: spin 1s linear infinite;
            vertical-align: middle; /* Align better with text */
            margin-right: 8px; /* Add spacing */
        }
        /* White spinner for buttons */
        .btn .loading {
             border: 2px solid rgba(255, 255, 255, 0.3);
             border-top-color: white;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-container {
                 flex-direction: column;
                 align-items: flex-start;
            }
            .nav-links {
                /* display: none; */ /* Or make it a hamburger menu */
                flex-direction: column;
                gap: 0.5rem;
                margin-top: 1rem;
                width: 100%;
            }
             .nav-links a {
                 padding: 0.8rem 1rem;
                 text-align: center;
                 background-color: #f8fafc;
             }
             .nav-links a:hover {
                 background: var(--primary);
                 color: white;
             }

            .wallet-section {
                 margin-top: 1rem;
                 width: 100%;
                 justify-content: space-between;
            }

             .main-content {
                 padding-top: 180px; /* Adjust based on taller mobile navbar */
             }

            .hero h1 {
                font-size: 2.5rem;
            }

            .section {
                padding: 1.5rem;
                margin: 1rem;
            }
        }

        /* History Section */
        .history-section {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1rem;
             border: 1px solid #e2e8f0;
             box-shadow: var(--shadow-sm);
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
             border: 1px solid #e2e8f0; /* Add border */
             border-radius: 0.5rem; /* Add border radius */
             margin-top: 1rem; /* Space from button */
        }

        .history-item {
            display: grid;
            grid-template-columns: minmax(100px, 1fr) minmax(200px, 3fr) auto; /* Adjusted columns */
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            align-items: center;
            background-color: #fff; /* Ensure background */
            transition: background-color 0.2s ease;
        }
         .history-item:hover {
             background-color: #f8fafc; /* Hover effect */
         }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-filename {
            font-weight: 500;
            color: var(--dark);
             overflow: hidden;
             text-overflow: ellipsis;
             white-space: nowrap;
        }

        .history-cid {
            font-family: monospace;
            color: var(--primary);
            word-break: break-all; /* Keep break-all for CID */
             background-color: #f0f4f8;
             padding: 0.2rem 0.4rem;
             border-radius: 4px;
             font-size: 0.85rem;
        }

        .history-timestamp {
            color: var(--gray);
            font-size: 0.875rem;
            text-align: right;
            white-space: nowrap; /* Prevent wrapping */
        }

        .empty-history {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            background-color: #f8fafc;
             border-radius: 0.5rem;
        }

        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 0.5rem; /* Space from timestamp */
        }

        .copy-btn:hover {
            background: var(--primary-dark);
        }

        /* CID History specific styles */
        #cid-history-display {
            margin-top: 1.5rem;
        }
        #cid-history-display table {
             width: 100%;
             border-collapse: collapse;
             margin-top: 1rem; /* Space from button */
             box-shadow: var(--shadow-sm);
             border-radius: 0.5rem;
             overflow: hidden; /* Clip corners */
        }
        #cid-history-display th,
        #cid-history-display td {
             border: 1px solid #e2e8f0;
             padding: 0.75rem 1rem;
             text-align: left;
        }
        #cid-history-display th {
             background-color: #f8fafc;
             font-weight: 600;
             color: var(--dark);
        }
        #cid-history-display td {
             background-color: white;
             font-size: 0.9rem;
        }
        #cid-history-display tr:nth-child(even) td {
             background-color: #f8fafc; /* Zebra striping */
        }
        #cid-history-display td:nth-child(1) { /* CID column */
             font-family: monospace;
             word-break: break-all;
        }
        #cid-history-display td:nth-child(3) { /* Actions column */
             text-align: center;
        }
         #cid-history-display .copy-cid-btn {
             background: var(--primary);
             color: white;
             border: none;
             padding: 0.3rem 0.6rem;
             border-radius: 0.25rem;
             font-size: 0.8rem;
             cursor: pointer;
             transition: background-color 0.2s ease;
         }
         #cid-history-display .copy-cid-btn:hover {
             background: var(--primary-dark);
         }

         /* Utility classes */
        .hidden {
             display: none;
        }

    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="#" class="logo">üß± BlockVault</a>
             <!-- Wallet Section integrated into Navbar -->
             <div class="wallet-section">
                 <button id="connectButton" class="btn">
                     <span id="connectButtonText">üîó Connect Wallet</span>
                     <span class="loading hidden"></span>
                 </button>
                 <div id="walletAddress" class="hidden"></div>
             </div>
             <!-- Optional: Keep nav links or use a hamburger menu for mobile -->
            <div class="nav-links">
                <a href="#uploadSection" onclick="showSection('upload')">Upload</a>
                <a href="#retrieveSection" onclick="showSection('retrieve')">Retrieve</a>
                <a href="#historySection" onclick="showSection('history')">History</a>
                <a href="#about" onclick="showSection('about')">About Us</a>
                <a href="#contact" onclick="showSection('contact')">Contact</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Hero Section (Optional - can be removed if sections cover all) -->
        <section class="hero">
            <h1>Secure Document Storage on Blockchain</h1>
            <p>Store your important documents securely using IPFS and Ethereum blockchain</p>
            <button class="btn btn-secondary" onclick="showSection('upload')">Get Started</button>
        </section>

        <!-- Upload Section -->
        <section id="uploadSection" class="section active"> {/* Default active section */}
            <h2>Upload Document</h2>
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" id="title" name="title" placeholder="Document Title" required />
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <input type="text" id="description" name="description" placeholder="Short description of the document" required />
            </div>

            <div class="form-group">
                <label>Document File</label>
                <div class="file-input-wrapper">
                    <label class="file-input-label" id="dropArea">
                        <div class="file-input-text">
                            <div class="file-input-icon">üìÑ</div>
                            <div id="file-name">Choose a file or drag it here</div>
                        </div>
                        <input type="file" name="document" id="document" required style="display: none;" />
                    </label>
                </div>
            </div>

            <button type="button" id="uploadButton" class="btn btn-primary">
                 <span id="uploadButtonText">Upload to Blockchain</span>
                 <span class="loading hidden"></span>
            </button>
            <div id="result" class="result"></div> {/* Ensure result div is always present */}
        </section>

        <!-- Retrieve Section -->
        <section id="retrieveSection" class="section hidden">
            <h2>Retrieve Document</h2>
            <div class="form-group">
                <label for="ipfsHash">IPFS Hash (CID)</label>
                <input type="text" id="ipfsHash" name="ipfsHash" placeholder="Enter IPFS Hash (CID) to retrieve document" required />
            </div>
            <button type="button" id="retrieveButton" class="btn btn-primary">
                <span id="retrieveButtonText">Fetch Document</span>
                <span class="loading hidden"></span>
            </button>
            <div id="output" class="output"></div> {/* Ensure output div is always present */}
        </section>

        <!-- History Section -->
        <section id="historySection" class="section hidden">
            <h2>Upload History (From Server)</h2>
            <button id="fetchHistoryButton" class="btn btn-secondary" onclick="fetchCIDHistory()">
                 <span id="fetchHistoryButtonText">View CID History</span>
                 <span class="loading hidden"></span>
            </button>
            <div id="cid-history-display">
                <div id="cidHistory">
                     <p class="empty-history">Click the button above to load history from the server.</p>
                </div>
            </div>
        </section>

        <!-- About Section -->
        <section id="about" class="section hidden">
            <h2>About BlockVault</h2>
            <p>Welcome to BlockVault!</p>
            <p>We are a passionate team of developers working to make document storage safer, smarter, and decentralized.</p>
            <p>Our project combines the power of IPFS (InterPlanetary File System) and Blockchain (Ethereum) to ensure your important documents are securely stored, easily accessible, and tamper-proof.</p>
            <p>With BlockVault, users can:</p>
            <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                <li>Upload files securely to IPFS via Pinata</li>
                <li>Connect their Ethereum wallet (MetaMask) for transaction verification</li>
                <li>Instantly get a unique IPFS hash for every upload</li>
                <li>Pay a small fee to store the document record permanently on the blockchain</li>
                <li>Maintain a history of all uploaded CIDs with timestamps (via server)</li>
                <li>Retrieve documents anytime using the IPFS hash</li>
            </ul>
        </section>

        <!-- Contact Section -->
        <section id="contact" class="section hidden">
            <h2>Contact Us</h2>
            <div class="contact-info">
                <p>üìû Phone: 123456789</p>
                <p>‚úâÔ∏è Email: abcdefgh@gmail.com</p>
            </div>
        </section>
    </div>

    <script>
        // --- Ethers.js, Contract Details, Global Variables ---
        let provider = null;
        let signer = null;
        let contract = null;
        // IMPORTANT: Replace with your ACTUAL deployed contract address
        const CONTRACT_ADDRESS = "0x5fbdb2d56cdae59174d9d44ca8992a9242998b8a"; // From your deploy script output
        const CONTRACT_ABI = [
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "ipfsHash",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "fileName",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "timestamp",
                        "type": "uint256"
                    }
                ],
                "name": "DocumentStored",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    }
                ],
                "name": "getDocuments",
                "outputs": [
                    {
                        "components": [
                            {
                                "internalType": "string",
                                "name": "ipfsHash",
                                "type": "string"
                            },
                            {
                                "internalType": "string",
                                "name": "fileName",
                                "type": "string"
                            },
                            {
                                "internalType": "uint256",
                                "name": "timestamp",
                                "type": "uint256"
                            }
                        ],
                        "internalType": "struct BlockVault.Document[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "ipfsHash",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "fileName",
                        "type": "string"
                    }
                ],
                "name": "storeDocument",
                "outputs": [],
                "stateMutability": "payable", // Crucial: function accepts ETH
                "type": "function"
            }
        ];

        // *** SET YOUR TRANSACTION FEE HERE ***
        // This is the amount sent *with* the transaction (in addition to gas)
        const UPLOAD_FEE_ETH = "0.001"; // Example: 0.001 ETH - Adjust as needed for affordability

        // DOM Elements (Cache frequently used elements)
        const connectButton = document.getElementById('connectButton');
        const connectButtonText = document.getElementById('connectButtonText');
        const connectLoading = connectButton?.querySelector('.loading');
        const walletAddressDiv = document.getElementById('walletAddress');

        const uploadButton = document.getElementById('uploadButton');
        const uploadButtonText = document.getElementById('uploadButtonText');
        const uploadLoading = uploadButton?.querySelector('.loading');
        const resultDiv = document.getElementById('result');

        const retrieveButton = document.getElementById('retrieveButton');
        const retrieveButtonText = document.getElementById('retrieveButtonText');
        const retrieveLoading = retrieveButton?.querySelector('.loading');
        const outputDiv = document.getElementById('output');

        const fetchHistoryButton = document.getElementById('fetchHistoryButton');
        const fetchHistoryButtonText = document.getElementById('fetchHistoryButtonText');
        const fetchHistoryLoading = fetchHistoryButton?.querySelector('.loading');
        const cidHistoryDiv = document.getElementById('cidHistory');

        const fileInput = document.getElementById('document');
        const fileNameDisplay = document.getElementById('file-name');
        const dropArea = document.getElementById('dropArea');
        const titleInput = document.getElementById('title');
        const descriptionInput = document.getElementById('description');
        const ipfsHashInput = document.getElementById('ipfsHash');

        // --- Initialization and Event Listeners ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded.");

            // Initial UI Setup
            showSection('upload'); // Show upload section by default
            if(resultDiv) resultDiv.innerHTML = ''; // Clear initial result text
            if(outputDiv) outputDiv.innerHTML = ''; // Clear initial output text


            // Attach Event Listeners Safely
            if (connectButton) {
                connectButton.onclick = connectWallet;
            } else { console.error("Connect button not found."); }

            if (uploadButton) {
                uploadButton.addEventListener('click', handleUpload);
            } else { console.error("Upload button not found."); }

            if (retrieveButton) {
                 retrieveButton.addEventListener('click', handleRetrieve);
            } else { console.error("Retrieve button not found."); }

            // File Input Handling
            if (fileInput && fileNameDisplay && dropArea) {
                fileInput.addEventListener('change', handleFileSelect);

                // Drag and drop handling
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false); // Prevent browser default drop behavior anywhere else
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
                });

                dropArea.addEventListener('drop', handleDrop, false);

            } else { console.error("File input elements not found."); }

            // Check MetaMask & Setup Listeners (Run after ethers.js is confirmed loaded)
            function initializeMetaMask() {
                 if (typeof window.ethereum === 'undefined') {
                     if (walletAddressDiv) {
                         walletAddressDiv.innerText = "‚ùå MetaMask not found";
                         walletAddressDiv.classList.remove('hidden');
                    }
                     if (connectButtonText) connectButtonText.innerText = "Install MetaMask";
                     if (connectButton) connectButton.onclick = () => { window.open("https://metamask.io/download/", "_blank"); }; // Link to install
                     // Disable buttons requiring wallet
                     if (uploadButton) uploadButton.disabled = true;
                     if (retrieveButton) retrieveButton.disabled = true; // Retrieve doesn't strictly need wallet, but good practice
                 } else {
                     // Set up MetaMask event listeners
                     window.ethereum.on('accountsChanged', handleAccountsChanged);
                     window.ethereum.on('chainChanged', handleChainChanged);
                     // Attempt auto-connect if previously connected (optional)
                     // connectWallet(true); // Pass flag for silent connect attempt
                 }
            }

            // Wait a brief moment for ethers.js to potentially load before checking MM
            setTimeout(initializeMetaMask, 500);

        });

        // --- Wallet Connection ---
        async function connectWallet(silent = false) {
            if (typeof window.ethers === 'undefined') {
                alert("Ethers.js library is not loaded. Cannot connect wallet.");
                return;
            }
            if (!window.ethereum) {
                alert("Please install MetaMask!");
                return;
            }

            setLoadingState(connectButton, connectLoading, true);
            if(connectButtonText) connectButtonText.textContent = "Connecting...";
            if(walletAddressDiv) {
                walletAddressDiv.innerText = "üîÑ Connecting...";
                walletAddressDiv.classList.remove('hidden');
            }

            try {
                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

                if (!accounts || accounts.length === 0) {
                    throw new Error("No accounts found. Please unlock MetaMask or create an account.");
                }

                // Initialize ethers provider (v6 syntax)
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                const address = await signer.getAddress();
                const network = await provider.getNetwork();

                // Initialize contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // Update UI
                const formattedAddress = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
                if(walletAddressDiv) {
                    walletAddressDiv.innerText = `üü¢ ${formattedAddress} (${network.name})`;
                    walletAddressDiv.classList.remove('hidden');
                }
                if(connectButtonText) connectButtonText.textContent = "‚úÖ Connected";
                if(connectButton) connectButton.classList.add('connected');

                // Re-enable buttons
                if (uploadButton) uploadButton.disabled = false;
                if (retrieveButton) retrieveButton.disabled = false;
                if (fetchHistoryButton) fetchHistoryButton.disabled = false;

            } catch (err) {
                console.error("Wallet connection failed:", err);
                const message = err.code === 4001 ? "Connection rejected by user." : (err.message || "Unknown error");
                if(walletAddressDiv) {
                    walletAddressDiv.innerText = `‚ùå ${message}`;
                    walletAddressDiv.classList.remove('hidden');
                }
                if(connectButtonText) connectButtonText.textContent = "Connection Failed";
                if(connectButton) connectButton.classList.remove('connected');
                // Keep buttons disabled if connection fails
                if (uploadButton) uploadButton.disabled = true;
                if (retrieveButton) retrieveButton.disabled = true;
                if (fetchHistoryButton) fetchHistoryButton.disabled = true;

                if (!silent) alert("Failed to connect wallet: " + message);

            } finally {
                setLoadingState(connectButton, connectLoading, false);
            }
        }

        // --- MetaMask Event Handlers ---
         function handleAccountsChanged(accounts) {
             console.log("Accounts changed:", accounts);
             if (accounts.length === 0) {
                 // MetaMask disconnected
                 provider = null;
                 signer = null;
                 contract = null;
                 if(walletAddressDiv) {
                      walletAddressDiv.innerText = "‚ùå Disconnected";
                      walletAddressDiv.classList.remove('hidden'); // Keep visible
                 }
                 if(connectButtonText) connectButtonText.textContent = 'üîó Connect Wallet';
                 if(connectButton) connectButton.classList.remove('connected');
                 // Disable buttons
                 if (uploadButton) uploadButton.disabled = true;
                 if (retrieveButton) retrieveButton.disabled = true;
                  if (fetchHistoryButton) fetchHistoryButton.disabled = true;

             } else {
                 // Account switched, reconnect
                 connectWallet();
             }
         }

         function handleChainChanged() {
             console.log("Network changed");
             alert("Network changed! Reloading the page to ensure compatibility.");
             window.location.reload();
         }


        // --- Section Navigation ---
        function showSection(sectionId) {
            console.log("Showing section:", sectionId);
            const sections = document.querySelectorAll('.main-content .section');
            sections.forEach(s => {
                if (s.id === sectionId + 'Section') {
                    s.classList.remove('hidden');
                    s.classList.add('active'); // For potential animation
                } else {
                    s.classList.add('hidden');
                    s.classList.remove('active');
                }
            });

             // Optional: Update active link in navbar
             const navLinks = document.querySelectorAll('.nav-links a');
             navLinks.forEach(link => {
                 if (link.getAttribute('href') === `#${sectionId}Section`) {
                     link.style.fontWeight = '700'; // Example active style
                     link.style.color = 'var(--primary)';
                 } else {
                     link.style.fontWeight = '500';
                     link.style.color = 'var(--dark)';
                 }
             });

              // If showing history, maybe auto-fetch?
             // if (sectionId === 'history' && cidHistoryDiv && cidHistoryDiv.querySelector('.empty-history')) {
             //     fetchCIDHistory();
             // }
        }

        // --- File Input Handling ---
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                updateFileName(files[0].name);
            } else {
                updateFileName('Choose a file or drag it here');
            }
        }

        function handleDrop(event) {
            const dt = event.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                 fileInput.files = files; // Assign dropped files to the input
                 updateFileName(files[0].name);
            } else {
                 updateFileName('Choose a file or drag it here');
            }
        }

         function updateFileName(name) {
             if (fileNameDisplay) {
                 fileNameDisplay.textContent = name;
                 if (name !== 'Choose a file or drag it here' && dropArea) {
                     dropArea.classList.add('file-selected');
                 } else if(dropArea) {
                     dropArea.classList.remove('file-selected');
                 }
             }
         }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // --- UI Helpers ---
        function setLoadingState(button, loader, isLoading) {
            if(!button || !loader) return;
            if (isLoading) {
                button.disabled = true;
                loader.classList.remove('hidden');
            } else {
                button.disabled = false;
                loader.classList.add('hidden');
            }
        }

        function displayMessage(element, message, type = 'info') {
            if (!element) return;
            let className = 'info-message'; // Default
            if (type === 'success') className = 'success-message';
            if (type === 'error') className = 'error-message';

            element.innerHTML = `
                <div class="${className} animate__animated animate__fadeIn">
                    ${message}
                </div>`;
        }

        // --- Core Functionality: Upload ---
        async function handleUpload() {
            console.log("handleUpload started");
            if (!uploadButton) return;

            setLoadingState(uploadButton, uploadLoading, true);
            if(uploadButtonText) uploadButtonText.textContent = 'Processing...';
            displayMessage(resultDiv, `<p><span class="loading"></span> Preparing upload...</p>`, 'info');

            // 1. Check Wallet Connection
            if (!provider || !signer || !contract) {
                displayMessage(resultDiv, `
                    <p>‚ùå Wallet not connected.</p>
                    <p>Please connect your wallet first to upload.</p>
                    <button onclick="connectWallet()" class="btn btn-primary" style="margin-top: 10px;">Connect Wallet</button>
                `, 'error');
                setLoadingState(uploadButton, uploadLoading, false);
                if(uploadButtonText) uploadButtonText.textContent = 'Upload to Blockchain';
                return;
            }

            // 2. Get Form Data and Validate
            const file = fileInput?.files[0];
            const title = titleInput?.value;
            const description = descriptionInput?.value;

            if (!file || !title?.trim() || !description?.trim()) {
                let errorMsg = "‚ùå Please fill in all fields: ";
                if (!title?.trim()) errorMsg += "Title, ";
                if (!description?.trim()) errorMsg += "Description, ";
                if (!file) errorMsg += "File";
                displayMessage(resultDiv, `<p>${errorMsg.replace(/, $/, '')}.</p>`, 'error');
                setLoadingState(uploadButton, uploadLoading, false);
                if(uploadButtonText) uploadButtonText.textContent = 'Upload to Blockchain';
                return;
            }

            // 3. First, trigger MetaMask transaction
            displayMessage(resultDiv, `
                <p><span class="loading"></span> Please approve the transaction in MetaMask...</p>
                <p>This will transfer ${UPLOAD_FEE_ETH} ETH to store your document on the blockchain.</p>`, 'info');

            try {
                // Prepare transaction options
                const txOptions = {
                    value: ethers.parseEther(UPLOAD_FEE_ETH),
                };

                console.log("Sending transaction to contract:", { fileName: file.name, options: txOptions });
                
                // This will trigger MetaMask popup first
                const tx = await contract.storeDocument("", file.name, txOptions);
                console.log("Transaction sent:", tx.hash);

                displayMessage(resultDiv, `
                    <p>‚úÖ Transaction sent! Hash: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener noreferrer">${tx.hash.substring(0, 10)}...</a></p>
                    <p><span class="loading"></span> Waiting for transaction confirmation...</p>`, 'info');

                // Wait for transaction confirmation
                const receipt = await tx.wait();
                console.log("Transaction mined:", receipt);

                // 4. After transaction is confirmed, upload to IPFS
                displayMessage(resultDiv, `<p><span class="loading"></span> Transaction confirmed! Now uploading to IPFS...</p>`, 'info');
                
                const formData = new FormData();
                formData.append('document', file);
                formData.append('title', title);
                formData.append('description', description);

                const response = await fetch('http://localhost:5000/upload', {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || `Server error: ${response.statusText}`);
                }
                const ipfsHash = data.hash;
                console.log("IPFS upload successful:", ipfsHash);

                // Calculate costs
                const gasUsed = receipt.gasUsed;
                const gasPrice = receipt.effectiveGasPrice || tx.gasPrice;
                const gasCostWei = gasUsed * gasPrice;
                const gasCostEth = ethers.formatEther(gasCostWei);
                const totalCostEth = (parseFloat(ethers.formatEther(txOptions.value)) + parseFloat(gasCostEth)).toFixed(6);

                // Display Success
                displayMessage(resultDiv, `
                    <h3 style="color: var(--secondary-dark); margin-top: 0;">‚úÖ Upload & Storage Successful!</h3>
                    <p><strong>File:</strong> ${escapeHtml(file.name)}</p>
                    <p><strong>IPFS Hash (CID):</strong> <code style="background:#eee; padding: 2px 5px; border-radius:3px;">${ipfsHash}</code></p>
                    <p><strong>Blockchain Record:</strong> Confirmed in block ${receipt.blockNumber}</p>
                    <p><strong>Transaction Hash:</strong> <a href="https://sepolia.etherscan.io/tx/${receipt.transactionHash}" target="_blank" rel="noopener noreferrer">${receipt.transactionHash.substring(0, 10)}...${receipt.transactionHash.substring(receipt.transactionHash.length - 8)}</a></p>
                    <p><strong>Total Cost:</strong> ‚âà${totalCostEth} ETH (${UPLOAD_FEE_ETH} ETH fee + ${gasCostEth.substring(0,8)} ETH gas)</p>
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <a href="https://ipfs.io/ipfs/${ipfsHash}" target="_blank" rel="noopener noreferrer" class="btn btn-secondary" style="flex: 1;">View on IPFS Gateway</a>
                        <button onclick="copyToClipboard('${ipfsHash}')" class="btn" style="flex: 1; background: var(--gray); color: white;">Copy IPFS Hash</button>
                        <button onclick="showSection('retrieve'); if(ipfsHashInput) ipfsHashInput.value='${ipfsHash}';" class="btn btn-primary" style="flex: 1;">Retrieve Now</button>
                    </div>
                `, 'success');

                // Reset Form
                resetUploadForm();

            } catch (error) {
                console.error("Upload failed:", error);
                let errorDetail = error.message || 'Unknown error';
                let errorCode = error.code;

                if (error.data?.message) {
                    errorDetail = error.data.message;
                } else if (error.reason) {
                    errorDetail = error.reason;
                }

                if (errorCode === 4001 || errorDetail.includes("rejected")) {
                    errorDetail = "Transaction rejected by user in MetaMask.";
                } else if (errorDetail.includes("insufficient funds")) {
                    errorDetail = "Insufficient funds for transaction fee + gas.";
                }

                displayMessage(resultDiv, `
                    <p>‚ùå Upload failed!</p>
                    <p><strong>Error:</strong> ${escapeHtml(errorDetail)}</p>
                `, 'error');
            } finally {
                setLoadingState(uploadButton, uploadLoading, false);
                if(uploadButtonText) uploadButtonText.textContent = 'Upload to Blockchain';
            }
        }

         function resetUploadForm() {
             if (titleInput) titleInput.value = '';
             if (descriptionInput) descriptionInput.value = '';
             if (fileInput) fileInput.value = ''; // Clears the file input
             updateFileName('Choose a file or drag it here'); // Reset file name display
              // Don't clear resultDiv here, keep the success/error message
         }

        // --- Core Functionality: Retrieve ---
        async function handleRetrieve() {
            console.log("handleRetrieve started");
            if (!retrieveButton || !ipfsHashInput || !outputDiv) return;

             const ipfsHash = ipfsHashInput.value.trim();
             if (!ipfsHash) {
                 displayMessage(outputDiv, `<p>‚ùå Please enter an IPFS Hash (CID).</p>`, 'error');
                 return;
             }

            setLoadingState(retrieveButton, retrieveLoading, true);
            if(retrieveButtonText) retrieveButtonText.textContent = 'Fetching...';
            // Basic retrieve just provides links - no async needed here unless verifying hash first
            displayMessage(outputDiv, `<p><span class="loading"></span> Preparing links for IPFS hash...</p>`, 'info');


             try {
                 // Basic validation (could add more sophisticated CID check)
                 if (!ipfsHash.startsWith('Qm') && !ipfsHash.startsWith('bafy')) {
                     // Basic check, not exhaustive
                     displayMessage(outputDiv, `<p>‚ö†Ô∏è Warning: '${escapeHtml(ipfsHash)}' doesn't look like a standard IPFS CID. Links might not work.</p>`, 'error'); // Use error style for visibility
                     // Still provide links in case it's valid
                 }

                 // Provide links immediately
                 const ipfsGatewayLink = `https://ipfs.io/ipfs/${ipfsHash}`;
                 // You can add more gateways if desired
                 // const cloudflareGatewayLink = `https://cloudflare-ipfs.com/ipfs/${ipfsHash}`;

                  displayMessage(outputDiv, `
                     <h3 style="color: var(--dark); margin-top: 0;">üìÑ Document Access</h3>
                     <p><strong>IPFS Hash (CID):</strong> <code style="background:#eee; padding: 2px 5px; border-radius:3px;">${escapeHtml(ipfsHash)}</code></p>
                     <p>Use the buttons below to view or download the file directly from a public IPFS gateway.</p>
                     <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                         <a href="${ipfsGatewayLink}" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="flex: 1;">View via ipfs.io</a>
                         <a href="${ipfsGatewayLink}?download=true" download target="_blank" rel="noopener noreferrer" class="btn btn-secondary" style="flex: 1;">Download File</a>
                         <button onclick="copyToClipboard('${ipfsHash}')" class="btn" style="flex: 1; background: var(--gray); color: white;">Copy IPFS Hash</button>
                     </div>
                      <p style="margin-top: 15px; font-size: 0.9em; color: var(--gray);">Note: File availability depends on the IPFS network. If the file isn't found, it might not be pinned or propagated yet.</p>
                 `, 'success'); // Use success style for the result display

             } catch (err) { // Should be unlikely here unless JS error
                 console.error("Retrieve error:", err);
                 displayMessage(outputDiv, `<p>‚ùå An unexpected error occurred: ${escapeHtml(err.message)}</p>`, 'error');
             } finally {
                  setLoadingState(retrieveButton, retrieveLoading, false);
                  if(retrieveButtonText) retrieveButtonText.textContent = 'Fetch Document';
             }
        }

        // --- Core Functionality: History ---
        async function fetchCIDHistory() {
             console.log("Fetching CID history from server...");
             if (!fetchHistoryButton || !cidHistoryDiv) return;

             setLoadingState(fetchHistoryButton, fetchHistoryLoading, true);
             if(fetchHistoryButtonText) fetchHistoryButtonText.textContent = 'Loading...';
             displayMessage(cidHistoryDiv, `<p><span class="loading"></span> Loading history from server...</p>`, 'info');


             try {
                 const response = await fetch('http://localhost:5000/cid-history');
                 if (!response.ok) {
                     throw new Error(`Server error: ${response.status} ${response.statusText}`);
                 }
                 const result = await response.json();

                 if (result.success) {
                     renderCIDHistory(result.history);
                 } else {
                     throw new Error(result.error || 'Failed to fetch history data.');
                 }
             } catch (error) {
                 console.error('Error fetching CID history:', error);
                 displayMessage(cidHistoryDiv, `<p>‚ùå Error loading history: ${escapeHtml(error.message)}</p>`, 'error');
             } finally {
                  setLoadingState(fetchHistoryButton, fetchHistoryLoading, false);
                  if(fetchHistoryButtonText) fetchHistoryButtonText.textContent = 'View CID History';
             }
        }

         function renderCIDHistory(history) {
             if (!cidHistoryDiv) return;

             if (!history || history.length === 0) {
                 cidHistoryDiv.innerHTML = `<p class="empty-history">No upload history found on the server.</p>`;
                 return;
             }

             // Create Table
             let tableHTML = `
                 <table>
                     <thead>
                         <tr>
                             <th>IPFS Hash (CID)</th>
                             <th>Timestamp (IST)</th>
                             <th>Actions</th>
                         </tr>
                     </thead>
                     <tbody>
             `;

             // Sort history newest first
             history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

             // Table Data
             history.forEach(item => {
                 // Convert to IST
                 const date = new Date(item.timestamp);
                 const options = {
                     timeZone: 'Asia/Kolkata',
                     year: 'numeric',
                     month: '2-digit',
                     day: '2-digit',
                     hour: '2-digit',
                     minute: '2-digit',
                     hour12: true
                 };
                 const formattedTimestamp = date.toLocaleString('en-IN', options) + ' IST';

                 tableHTML += `
                     <tr>
                         <td>${escapeHtml(item.cid)}</td>
                         <td>${escapeHtml(formattedTimestamp)}</td>
                         <td>
                             <button onclick="copyToClipboard('${escapeHtml(item.cid)}')" class="copy-cid-btn" title="Copy CID">üìã Copy</button>
                             <button onclick="showSection('retrieve'); if(ipfsHashInput) ipfsHashInput.value='${escapeHtml(item.cid)}';" class="copy-cid-btn" title="Retrieve this file" style="background: var(--secondary); margin-left: 5px;">üîé Retrieve</button>
                         </td>
                     </tr>
                 `;
             });

             tableHTML += `
                     </tbody>
                 </table>
             `;

             cidHistoryDiv.innerHTML = tableHTML;
         }


        // --- Utility Functions ---
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showTemporaryTooltip('Copied!');
                console.log('Copied to clipboard:', text);
            }).catch(err => {
                 console.error('Failed to copy text: ', err);
                 alert("Failed to copy. Your browser might not support this feature or permission was denied.");
            });
        }

        function showTemporaryTooltip(message) {
             const tooltip = document.createElement('div');
             tooltip.textContent = message;
             Object.assign(tooltip.style, {
                 position: 'fixed',
                 top: '20px', // Position at top-center
                 left: '50%',
                 transform: 'translateX(-50%)',
                 padding: '10px 20px',
                 background: 'rgba(0, 0, 0, 0.8)',
                 color: 'white',
                 borderRadius: '5px',
                 zIndex: '9999',
                 fontSize: '0.9em',
                 animation: 'fadeInOut 2s ease forwards' // Animation name and duration
             });

             // Add keyframe animation style if not already present
             if (!document.getElementById('fadeInOutKeyframes')) {
                 const style = document.createElement('style');
                 style.id = 'fadeInOutKeyframes';
                 style.textContent = `
                 @keyframes fadeInOut {
                     0% { opacity: 0; transform: translate(-50%, -20px); } /* Start above */
                     20% { opacity: 1; transform: translate(-50%, 0); }   /* Fade in */
                     80% { opacity: 1; transform: translate(-50%, 0); }   /* Stay visible */
                     100% { opacity: 0; transform: translate(-50%, -20px); } /* Fade out up */
                 }`;
                 document.head.appendChild(style);
             }

             document.body.appendChild(tooltip);

             // Remove tooltip after animation
             setTimeout(() => {
                  if (document.body.contains(tooltip)) {
                     document.body.removeChild(tooltip);
                  }
             }, 2000); // Match animation duration
         }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

    </script>
</body>

</html>